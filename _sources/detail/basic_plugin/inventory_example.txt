.. include:: ../../definition.txt

====================
|defInventory| の例
====================

|defInventory| は、BasicPlugin でプレイヤーが所持しているコンテンツを管理するための仕組みです。

交換や課金でプレイヤーに付与されたコンテンツは、|defInventory| に格納されていきます。

以下に、|defInventory| を管理するための player_inventories テーブル構造の一部を示します。

* |defInventory| テーブル
    * inventory_id  
        プレイヤーの |defInventory| 内の個々のコンテンツにユニークに与えられた |defId|
    * content_id  
        格納されているコンテンツの |defId|
    * content_type  
        格納されているコンテンツの種別
    * amount
        格納されているコンテンツの個数
        コンテンツが UncountableContent の場合、常に1が入りますが、プレゼント情報が付与されている場合のみ、個数として扱います。
    * description
        |defInventory| に格納されているコンテンツの名前や説明文
    * expire_at  
        コンテンツの有効期限
        paymentやpresentで使用します。

数量で扱うコンテンツと、同名でも1つずつ別のものとして扱うコンテンツについて
================================================================================

プレイヤーの |defInventory| に付与されたコンテンツが、|defCountable| である場合と、|defUncountable| である場合とで格納のされ方が違います。

|defCountable| の場合は「数量で扱う」コンテンツとして合算処理され、|defUncountable| の場合は「１つずつ別の物として扱う」コンテンツとして処理されます。

以下のように設定された |defContent| マスタと、 |defInventory| があるとし、例を示します。

* Content マスタ  
    例の |defContent| マスタは、|defCountable| である「お金」と「回復薬」および、|defUncountable| である「キャラクター1」が定義されています。

+--------------+------+---------+----+-------------+
|パラメータ名  |内容                               |
+==============+======+=========+====+=============+
|content_id    |1     |2        |... |101          |
+--------------+------+---------+----+-------------+
|content_type  |gold  |item     |... |character    |
+--------------+------+---------+----+-------------+
|description   |お金  |アイテム |... |キャラクター |
+--------------+------+---------+----+-------------+
|is_countable  |TRUE  |TRUE     |... |FALSE        |
+--------------+------+---------+----+-------------+
|is_payment    |FALSE |FALSE    |... |FALSE        |
+--------------+------+---------+----+-------------+
|max_amount    |99999 |99       |... |1            |
+--------------+------+---------+----+-------------+
|system_effect |      |         |    |             |
+--------------+------+---------+----+-------------+

* |defInventory| テーブル
    例のテーブルには、あらかじめ「お金」と「キャラクター1」が格納されています。

+-------------+-------+----+--------------+
|パラメータ名 |内容                       |
+=============+=======+====+==============+
|player_id    |1234   |... |1234          |
+-------------+-------+----+--------------+
|inventory_id |1      |... |20            |
+-------------+-------+----+--------------+
|content_id   |1      |... |101           |
+-------------+-------+----+--------------+
|content_type |item   |... |character     |
+-------------+-------+----+--------------+
|amount       |250    |... |0             |
+-------------+-------+----+--------------+
|description  |お金   |... |キャラクター1 |
+-------------+-------+----+--------------+
|expire_at    |       |    |              |
+-------------+-------+----+--------------+

お金、回復薬といった「数量で扱う」コンテンツ
--------------------------------------------------

例のテーブルで、コンテンツ「お金」が100個プレイヤーに付与されると、以下のように格納されます。

* コンテンツ「お金」を100個付与後の |defInventory| テーブル

+-------------+-------+----+--------------+
|パラメータ名 |内容                       |
+=============+=======+====+==============+
|player_id    |1234   |... |1234          |
+-------------+-------+----+--------------+
|inventory_id |1      |... |20            |
+-------------+-------+----+--------------+
|content_id   |1      |... |101           |
+-------------+-------+----+--------------+
|content_type |item   |... |character     |
+-------------+-------+----+--------------+
|amount       |350    |... |0             |
+-------------+-------+----+--------------+
|description  |お金   |... |キャラクター1 |
+-------------+-------+----+--------------+
|expire_at    |       |    |              |
+-------------+-------+----+--------------+

|defInventory| の「お金」の ``amount`` が付与分だけ加算されています。
    
同名でも個々で扱うコンテンツ  
------------------------------

続いて、コンテンツ「キャラクター1」がプレイヤーに付与をされると、|defInventory| には以下のように格納されます。

* コンテンツ「キャラクター1」付与後の player_inventories テーブル

+-------------+-------+----+--------------+--------------+
|パラメータ名 |内容                                      |
+=============+=======+====+==============+==============+
|player_id    |1234   |... |1234          |1234          |
+-------------+-------+----+--------------+--------------+
|inventory_id |1      |... |20            |21            |
+-------------+-------+----+--------------+--------------+
|content_id   |1      |... |101           |101           |
+-------------+-------+----+--------------+--------------+
|content_type |item   |... |character     |character     |
+-------------+-------+----+--------------+--------------+
|amount       |350    |... |0             |0             |
+-------------+-------+----+--------------+--------------+
|description  |お金   |... |キャラクター1 |キャラクター1 |
+-------------+-------+----+--------------+--------------+
|expire_at    |       |    |              |              |
+-------------+-------+----+--------------+--------------+

|defInventory| の「キャラクター1」は合算されず、新規のレコードとして追加処理されます。

課金要素の扱いについて
==============================

|defPayment| の場合、 |defInventory| への付与時に ``expire_at`` に対し有効期限が格納されます。

以下のように |defPayment| レコードを持つコンテンツがあるとし、例を示します。

* Content マスタ

+--------------+----+---------------+
|パラメータ名  |内容                |
+==============+====+===============+
|content_id    |... |1001           |
+--------------+----+---------------+
|content_type  |... |payment        |
+--------------+----+---------------+
|description   |... |課金コンテンツ |
+--------------+----+---------------+
|is_countable  |... |TRUE           |
+--------------+----+---------------+
|is_payment    |... |TRUE           |
+--------------+----+---------------+
|max_amount    |... |99999          |
+--------------+----+---------------+
|system_effect |    |               |
+--------------+----+---------------+

課金処理によって、コンテンツ「課金コンテンツ」が5個プレイヤーに付与されると、|defInventory|  には以下のように格納されます。

* |defInventory| テーブル

有効期限を示す ``expire_at`` が共に格納され、この有効期限を過ぎたレコードは無効化されます。

+-------------+----+--------------------+
|パラメータ名 |内容                     |
+=============+====+====================+
|player_id    |... |1234                |
+-------------+----+--------------------+
|inventory_id |... |56                  |
+-------------+----+--------------------+
|content_id   |... |1001                |
+-------------+----+--------------------+
|content_type |... |payment             |
+-------------+----+--------------------+
|amount       |... |5                   |
+-------------+----+--------------------+
|description  |... |課金コンテンツ      |
+-------------+----+--------------------+
|expire_at    |    |2016-09-16 12:34:56 |
+-------------+----+--------------------+

|defInventory| 内コンテンツの消費について
========================================

消費の対象が |defUncountable| であった時、 ``inventory_id`` がリクエストされた場合は特定の |defInventory| を消費します。

例えば、|defInventory| が以下の様な状態だとします。"キャラクター1" は |defUncountable| です。

+-------------+--------------+--------------+--------------+
|パラメータ名 |内容                                        |
+=============+==============+==============+==============+
|player_id    |1234          |1234          |1234          |
+-------------+--------------+--------------+--------------+
|inventory_id |1             |2             |3             |
+-------------+--------------+--------------+--------------+
|content_id   |101           |101           |101           |
+-------------+--------------+--------------+--------------+
|content_type |character     |character     |character     |
+-------------+--------------+--------------+--------------+
|amount       |0             |0             |0             |
+-------------+--------------+--------------+--------------+
|description  |キャラクター1 |キャラクター1 |キャラクター1 |
+-------------+--------------+--------------+--------------+
|expire_at    |              |              |              |
+-------------+--------------+--------------+--------------+

この |defInventory| で、"キャラクター1"を消費する ``inventory_id:2``  がリクエストがされた場合、|defInventory| は以下のように更新されます。

+-------------+--------------+--------------+
|パラメータ名 |内容                         |
+=============+==============+==============+
|player_id    |1234          |1234          |
+-------------+--------------+--------------+
|inventory_id |1             |2             |
+-------------+--------------+--------------+
|content_id   |101           |101           |
+-------------+--------------+--------------+
|content_type |character     |character     |
+-------------+--------------+--------------+
|amount       |0             |0             |
+-------------+--------------+--------------+
|description  |キャラクター1 |キャラクター1 |
+-------------+--------------+--------------+
|expire_at    |              |              |
+-------------+--------------+--------------+

消費の際に ``inventory_id`` のリクエストがない場合は以下のルールによって消費が行われます。

* 消費対象となった |defInventory| が |defCountable| ならば対象の ``content_id`` を持つコンテンツを消費
* 消費対象となった |defInventory| が |defUncountable| ならば |defInventory| に格納された順に消費
* 消費対象となった |defInventory| が |defPayment| ならば ``expire_at`` が近い順に消費

以下に |defUncountable| と |defPayment| の消費ルールの例を記載します。

例えば、|defInventory| が以下の様な状態だとします。 "キャラクター1" は |defUncountable| 、 "課金コンテンツ" は |defPayment| とします。
    
* |defInventory| テーブル

+-------------+--------------+--------------+----+--------------------+--------------------+
|パラメータ名 |内容                                                                        |
+=============+==============+==============+====+====================+====================+
|player_id    |1234          |1234          |... |1234                |1234                |
+-------------+--------------+--------------+----+--------------------+--------------------+
|inventory_id |1             |2             |... |56                  |57                  |
+-------------+--------------+--------------+----+--------------------+--------------------+
|content_id   |101           |101           |... |1001                |1001                |
+-------------+--------------+--------------+----+--------------------+--------------------+
|content_type |character     |character     |... |payment             |payment             |
+-------------+--------------+--------------+----+--------------------+--------------------+
|amount       |0             |0             |... |                    |                    |
+-------------+--------------+--------------+----+--------------------+--------------------+
|description  |キャラクター1 |キャラクター1 |... |課金コンテンツ      |課金コンテンツ      |
+-------------+--------------+--------------+----+--------------------+--------------------+
|expire_at    |              |              |... |2016-10-21 09:10:32 |2016-12-10 14:36:18 |
+-------------+--------------+--------------+----+--------------------+--------------------+

この |defInventory| で ``inventory_id`` のリクエスト無しで "キャラクター1" を1個、 "課金コンテンツ" を5個消費したとしたら、テーブルは以下のように更新されます。

* |defInventory| テーブル

+-------------+--------------+----+--------------------+
|パラメータ名 |内容                                    |
+=============+==============+====+====================+
|player_id    |1234          |... |1234                |
+-------------+--------------+----+--------------------+
|inventory_id |2             |... |57                  |
+-------------+--------------+----+--------------------+
|content_id   |101           |... |1001                |
+-------------+--------------+----+--------------------+
|content_type |character     |... |payment             |
+-------------+--------------+----+--------------------+
|amount       |0             |... |                    |
+-------------+--------------+----+--------------------+
|description  |キャラクター1 |... |課金コンテンツ      |
+-------------+--------------+----+--------------------+
|expire_at    |              |... |2016-12-10 14:36:18 |
+-------------+--------------+----+--------------------+

"キャラクター1" は格納された順に、 "課金コンテンツ" は ``expire_at`` が近い順に消費されました。


プレゼント状態のコンテンツについて
========================================

BasicPlugin では、 |defLoginBonus| 機能でプレイヤーの |defInventory| にプレゼント状態でコンテンツを付与することができます。

|defInventory| に、|defContent| が |defPresent| として格納された場合、以下のルールが適応されます。

* プレゼント状態のコンテンツが |defCountable| の場合、同じ ``content_id`` が存在しても加算せず、 |defInventory| の末尾に追加する
* プレゼント状態のコンテンツが |defUncountable| の場合、 ``amount`` を個数として扱い |defInventory| の末尾に追加する

|defPresent| 状態のコンテンツの格納例を以下に示します。 "お金" は |defCountable| "キャラクター1" と "武器1" は |defUncountable| とします。

+-------------+-----+-----------------+-----------------+-----------------+
|パラメータ名 |内容                                                       |
+=============+=====+=================+=================+=================+
|player_id    |1234 |1234             |1234             |1234             |
+-------------+-----+-----------------+-----------------+-----------------+
|inventory_id |1    |2                |3                |4                |
+-------------+-----+-----------------+-----------------+-----------------+
|content_id   |1    |1                |101              |201              |
+-------------+-----+-----------------+-----------------+-----------------+
|content_type |gold |present          |present          |present          |
+-------------+-----+-----------------+-----------------+-----------------+
|amount       |250  |50               |1                |2                |
+-------------+-----+-----------------+-----------------+-----------------+
|description  |お金 |ログインボーナス |ログインボーナス |ログインボーナス |
+-------------+-----+-----------------+-----------------+-----------------+
|expire_at    |     |                 |                 |                 |
+-------------+-----+-----------------+-----------------+-----------------+

|defPresent| の場合、|defCountable| であっても合算はされません。また、 |defUncountable| は ``amount`` に個数が入ります。
